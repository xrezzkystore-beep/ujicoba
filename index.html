<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XREZZKY STORE | Premium Marketplace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: white; overflow-x: hidden; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .hidden { display: none; }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 10px; }
    </style>
</head>
<body>

    <div id="profile-menu" class="hidden fixed top-16 left-4 glass p-4 rounded-xl w-64 z-50">
    <p id="profile-join" class="text-xs text-gray-400 mb-3"></p>

    <input type="text" id="new-username"
    placeholder="Ubah Username"
    class="w-full p-2 mb-2 rounded bg-slate-800 border border-slate-700 text-xs">

    <button onclick="updateUsername()"
    class="w-full bg-blue-600 py-2 rounded text-xs mb-2">
    Update Username</button>

    <button onclick="changePassword()"
    class="w-full bg-yellow-600 py-2 rounded text-xs mb-2">
    Ubah Password</button>

    <button onclick="logoutUser()"
    class="w-full bg-gray-600 py-2 rounded text-xs mb-2">
    Logout</button>

    <button onclick="deleteAccount()"
    class="w-full bg-red-600 py-2 rounded text-xs">
    Hapus Akun</button>
    </div>
    
    <div id="loader" class="fixed inset-0 flex items-center justify-center bg-slate-900 z-[999]">
        <div class="text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-blue-500 border-opacity-50 mb-4"></div>
            <p class="text-blue-400 font-bold tracking-widest">XREZZKY STORE</p>
        </div>
    </div>

    <section id="page-auth" class="hidden min-h-screen flex items-center justify-center p-6">
        <div class="glass p-8 rounded-2xl w-full max-w-md shadow-2xl">
            <h2 id="auth-title" class="text-3xl font-bold mb-2 text-center text-blue-500">Welcome</h2>
            <p id="auth-subtitle" class="text-gray-400 text-center mb-8 text-sm">Silahkan login untuk belanja</p>
            
            <div class="space-y-4">
                <div id="reg-fields" class="hidden space-y-4">
                    <input type="text" id="auth-user" placeholder="Username" class="w-full p-4 rounded-xl bg-slate-800 border border-slate-700 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <input type="email" id="auth-email" placeholder="Email Address" class="w-full p-4 rounded-xl bg-slate-800 border border-slate-700 focus:ring-2 focus:ring-blue-500 outline-none">
                <input type="password" id="auth-pass" placeholder="Password" class="w-full p-4 rounded-xl bg-slate-800 border border-slate-700 focus:ring-2 focus:ring-blue-500 outline-none">
                
                <button onclick="handleAuth()" id="btn-auth" class="w-full bg-blue-600 hover:bg-blue-700 py-4 rounded-xl font-bold transition-all transform active:scale-95 shadow-lg shadow-blue-900/20">Login</button>
                
                <div class="flex flex-col gap-3 text-center text-sm mt-6">
                    <span onclick="toggleAuthMode()" id="auth-toggle-text" class="text-blue-400 cursor-pointer hover:underline">Belum punya akun? Daftar sekarang</span>
                    <span onclick="resetPassword()" class="text-gray-500 cursor-pointer hover:text-white">Lupa kata sandi?</span>
                </div>
            </div>
        </div>
    </section>

    <section id="page-marketplace" class="hidden min-h-screen">
        <div class="flex justify-between items-center mb-4">

    <h2 class="text-xl font-bold">Marketplace</h2>

    <div class="flex items-center gap-3">

        <button onclick="toggleCart()" 
            class="relative bg-slate-700 px-3 py-1 rounded">

            üõí Keranjang

            <span id="cart-count"
                class="bg-red-500 text-xs px-2 py-1 rounded-full absolute -top-2 -right-2 hidden">
                0
            </span>

        </button>

        <button onclick="logout()" 
            class="bg-red-600 px-3 py-1 rounded">
            Logout
        </button>

    </div>
        </div>
        </header>

        <main class="p-4 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4" id="product-list">
            </main>

        <div class="fixed bottom-6 left-1/2 -translate-x-1/2 flex items-center gap-8 px-8 py-4 glass rounded-full z-50 shadow-2xl">
            <button onclick="showPage('page-marketplace')" class="text-blue-500"><i class="fa fa-home text-xl"></i></button>
            <a href="https://xrezzky-web.github.io/xrezzkystore/" class="bg-blue-600 p-4 rounded-full -mt-12 border-8 border-slate-900 shadow-xl"><i class="fa fa-shop text-white"></i></a>
            <button onclick="checkAdminAccess()" class="text-gray-400"><i class="fa fa-grid-2 text-xl"></i><i class="fa fa-user-shield text-xl"></i></button>
        </div>

        <!-- CART SECTION -->
<div id="cart-section" class="hidden mt-6 bg-slate-800 p-4 rounded">
    <h3 class="font-bold mb-2">Keranjang Saya</h3>
    <div id="cartList" class="space-y-2"></div>

    <button onclick="checkout()" 
        class="mt-3 bg-green-600 px-4 py-2 rounded">
        Checkout
    </button>
</div>

<!-- HISTORY -->
<div id="history-section" class="mt-6 bg-slate-800 p-4 rounded">
    <h3 class="font-bold mb-2">Riwayat Transaksi</h3>
    <div id="historyList" class="space-y-2"></div>
</div>
        
    </section>

    <section id="page-admin" class="hidden min-h-screen p-6 pb-24">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-2xl font-bold text-blue-500">Admin Panel</h1>
            <button onclick="showPage('page-marketplace')" class="bg-slate-700 px-4 py-2 rounded-lg text-xs">Keluar Admin</button>
            <div class="bg-slate-800 p-4 rounded mb-4">
    <h3 class="font-bold">Total Revenue</h3>
    <p id="totalRevenue" 
       class="text-green-400 text-xl">
       Rp 0
    </p>
</div>

<div id="adminTransactions" class="mb-4"></div>
        
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="glass p-6 rounded-2xl">
                <h3 class="font-bold mb-4 border-b border-slate-700 pb-2">Upload Produk Baru</h3>
                <div class="space-y-3">
                    <input type="text" id="p-name" placeholder="Nama Produk" class="w-full p-3 rounded bg-slate-800 border border-slate-700">
                    <input type="number" id="p-price" placeholder="Harga (Angka)" class="w-full p-3 rounded bg-slate-800 border border-slate-700">
                    <input type="text" id="p-img" placeholder="URL Foto Produk" class="w-full p-3 rounded bg-slate-800 border border-slate-700">
                    <textarea id="p-desc" placeholder="Detail Produk" class="w-full p-3 rounded bg-slate-800 border border-slate-700 h-24"></textarea>
                    <input type="number" id="p-stock" placeholder="Jumlah Stok" class="w-full p-3 rounded bg-slate-800 border border-slate-700">
                    <button onclick="saveProduct()" class="w-full bg-green-600 py-3 rounded-xl font-bold mt-2">Posting Produk</button>
                </div>
            </div>

            <div class="glass p-6 rounded-2xl">
                <h3 class="font-bold mb-4 border-b border-slate-700 pb-2">Laporan Penjualan</h3>
                <div id="admin-stats" class="grid grid-cols-2 gap-4">
                    <div class="bg-blue-900/30 p-4 rounded-xl text-center">
                        <p class="text-xs text-blue-300">Total User</p>
                        <p id="stat-users" class="text-2xl font-bold">0</p>
                    </div>
                    <div class="bg-green-900/30 p-4 rounded-xl text-center">
                        <p class="text-xs text-green-300">Total Produk</p>
                        <p id="stat-prods" class="text-2xl font-bold">0</p>
                    </div>
                </div>
                <div class="mt-6">
                    <h4 class="text-sm font-bold mb-2">Daftar Pengguna</h4>
                    <div id="admin-user-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
                    <h4 class="text-sm font-bold mb-2 mt-4">Pesanan Masuk</h4>
                    <div id="admin-order-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
                </div>
            </div>
        </div>
    </section>

    <div id="modal-detail" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/90">
        <div class="bg-slate-900 w-full max-w-xl rounded-3xl overflow-hidden relative border border-slate-700">
            <button onclick="closeModal('modal-detail')" class="absolute top-4 right-4 bg-white/10 p-2 rounded-full hover:bg-red-500 transition"><i class="fa fa-times w-5 h-5 flex items-center justify-center"></i></button>
            <img id="m-img" src="" class="w-full h-72 object-cover" onclick="viewImageFull(this.src)">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <h2 id="m-title" class="text-2xl font-bold"></h2>
                    <span id="m-stock" class="bg-blue-600/20 text-blue-400 text-[10px] px-3 py-1 rounded-full border border-blue-500/30"></span>
                </div>
                <p id="m-price" class="text-xl font-bold text-blue-500 mb-4"></p>
                <p id="m-desc" class="text-gray-400 text-sm mb-6 leading-relaxed"></p>
                
                <div class="grid grid-cols-2 gap-3">
                    <button id="btn-wa" class="bg-green-600 py-4 rounded-2xl font-bold flex items-center justify-center gap-2 transition hover:bg-green-700"><i class="fab fa-whatsapp text-xl"></i> Beli Sekarang</button>
                    <button onclick="alert('Masuk ke Keranjang!')" class="bg-slate-800 py-4 rounded-2xl font-bold border border-slate-700">Keranjang</button>
                </div>

                <div class="mt-8 pt-6 border-t border-slate-800">
                    <h4 class="font-bold mb-4 flex items-center gap-2"><i class="fa fa-star text-yellow-500"></i> Ulasan Pembeli</h4>
                    <div class="mt-4 border-t border-slate-700 pt-4">
    <h4 class="font-bold mb-2">Beri Rating</h4>

    <input type="range" id="star" min="1" max="5" value="5"
        class="w-full accent-yellow-400"
        oninput="document.getElementById('starValue').innerText=this.value">

    <p class="text-yellow-400 mb-2">
        ‚≠ê <span id="starValue">5</span>/5
    </p>

    <textarea id="reviewText"
        class="w-full p-2 rounded bg-slate-800 border border-slate-700 text-xs"
        placeholder="Tulis ulasan..."></textarea>

    <button onclick="sendRating(currentProductId,
        document.getElementById('star').value,
        document.getElementById('reviewText').value)"
        class="w-full bg-yellow-500 py-2 rounded mt-2 text-black font-bold">
        Kirim Rating
    </button>
                    </div>
                    <div id="review-list" class="space-y-4 max-h-40 overflow-y-auto text-xs text-gray-500">
                        <p class="italic text-center">Belum ada ulasan untuk produk ini.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, get, onValue, push, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Konfigurasi Firebase sesuai permintaan Anda
        const firebaseConfig = {
            apiKey: "AIzaSyA75bdcfawOi957by8y_4-l4sJCCo6pF88",
            authDomain: "xrezzkystore-marketplace-83bc0.firebaseapp.com",
            databaseURL: "https://xrezzkystore-marketplace-83bc0-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "xrezzkystore-marketplace-83bc0",
            storageBucket: "xrezzkystore-marketplace-83bc0.firebasestorage.app",
            messagingSenderId: "604900856944",
            appId: "1:604900856944:web:c48c973da45214c68a10b5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let cart = [];

window.toggleCart = () => {
    document.getElementById("cart-section").classList.toggle("hidden");
};

function updateCartCount() {
    const badge = document.getElementById("cart-count");
    badge.textContent = cart.length;
    badge.classList.toggle("hidden", cart.length === 0);
}

window.addToCart = async (productId, stock) => {
    cart.push(product);
    updateCartCount();
};

async function canBuy(user){
    const snap = await get(ref(db, `transactions/${user.uid}`));
    let pending = 0;

    if(snap.exists()){
        snap.forEach(t=>{
            if(t.val().status === "pending"){
                pending++;
            }
        });
    }

    return pending < 2;
}
        
        window.addEventListener("error", (e) => {
    console.log("GLOBAL ERROR:", e.message);
    document.getElementById('loader').classList.add('hidden');
});

        let isLoginMode = true;
        let globalProducts = [];
        let currentProductId = null;
        
        // 1. AUTH LOGIC
        window.toggleAuthMode = () => {
            isLoginMode = !isLoginMode;
            document.getElementById('reg-fields').classList.toggle('hidden', isLoginMode);
            document.getElementById('auth-title').innerText = isLoginMode ? "Welcome Back" : "Join Us";
            document.getElementById('btn-auth').innerText = isLoginMode ? "Login" : "Daftar Akun";
            document.getElementById('auth-toggle-text').innerText = isLoginMode ? "Belum punya akun? Daftar sekarang" : "Sudah punya akun? Login";
        };

        window.handleAuth = async () => {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            const user = document.getElementById('auth-user').value;

            if(!email || !pass) return alert("Isi semua data!");

            try {
                if (isLoginMode) {
                    await signInWithEmailAndPassword(auth, email, pass);
                } else {
                    const res = await createUserWithEmailAndPassword(auth, email, pass);
                    await set(ref(db, 'users/' + res.user.uid), {
                        username: user || email.split('@')[0],
                        email: email,
                        role: 'user',
                        joinDate: new Date().toLocaleDateString()
                    });
                }
            } catch (e) { alert(e.message); }
        };

        onAuthStateChanged(auth, (user) => {
    document.getElementById('loader').classList.add('hidden');

    if (user) {

        if(user.email === "xrezzkystore.id@gmail.com"){
            showPage('page-admin');
            loadRevenue(); // <<< WAJIB DISINI
        } else {
            showPage('page-marketplace');
            loadCart();     // <<< TAMBAH
            loadHistory();  // <<< TAMBAH
        }

        fetchUserData(user.uid);
        listenProducts();
        listenStats();

    } else {
        showPage('page-auth');
    }
});
        
        async function fetchUserData(uid) {
            const snap = await get(ref(db, 'users/' + uid));
            if(snap.exists()){
                const data = snap.val();
                document.getElementById('user-name-display').innerText = data.username;
                document.getElementById('user-avatar').src = `https://ui-avatars.com/api/?name=${data.username}&background=3b82f6&color=fff`;
            }
        }

        // 2. PRODUCT LOGIC (USER)
        function listenProducts() {
            onValue(ref(db, 'products'), (snap) => {
                const data = snap.val();
                const container = document.getElementById('product-list');
                container.innerHTML = "";
                globalProducts = [];
                
                if(!data) {
                    container.innerHTML = `<p class="col-span-full text-center text-gray-600 py-20">Belum ada produk tersedia.</p>`;
                    return;
                }

                for(let id in data) {
                    const p = data[id];
                    globalProducts.push({...p, id});
                    const isOut = p.stock <= 0;
                    
                    container.innerHTML += `
                        <div class="glass rounded-2xl overflow-hidden group cursor-pointer transition-all hover:scale-[1.02]" onclick="viewDetail('${id}')">
                            <div class="relative h-40">
                            ${auth.currentUser?.email === "xrezzkystore.id@gmail.com" ? 
                           `<button onclick="deleteProduct('${id}')" 
                              class="absolute top-2 right-2 bg-red-600 text-xs px-2 py-1 rounded">Hapus</button>` : ''}
                                <img src="${p.images ? p.images[0] : p.image}" class="w-full h-full object-cover">
                                ${isOut ? '<div class="absolute inset-0 bg-black/70 flex items-center justify-center text-xs font-bold text-red-500">HABIS</div>' : ''}
                            </div>
                            <div class="p-3">
                                <h3 class="font-bold text-sm truncate mb-1">${p.name}</h3>
                                <div class="flex justify-between items-center">
                                    <p class="text-blue-500 font-bold text-sm">Rp ${Number(p.price).toLocaleString()}</p>
                                    <p class="text-[9px] text-gray-500">Sisa ${p.stock}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });
        }

        onValue(ref(db, 'orders'), (snap) => {
    const list = document.getElementById('admin-order-list');
    if(!list) return;
    list.innerHTML = "";

    snap.forEach(child => {
        const o = child.val();
        list.innerHTML += `
            <div class="bg-slate-800 p-3 rounded">
                <p class="text-xs">${o.productName}</p>
                <p class="text-[10px] text-yellow-400">${o.status}</p>
                <button onclick="confirmOrder('${child.key}')" 
                class="text-green-500 text-xs">
                Konfirmasi</button>
            </div>
        `;
    });
});
        
        

        window.viewDetail = (id) => {
            currentProductId = id;
            const p = globalProducts.find(x => x.id === id);
            loadRatings(id);
            document.getElementById('m-title').innerText = p.name;
            document.getElementById('m-price').innerText = "Rp " + Number(p.price).toLocaleString();
            document.getElementById('m-desc').innerText = p.description;
            let firstImg = p.images ? p.images[0] : p.image;
            document.getElementById('m-img').src = firstImg;
            document.getElementById('m-stock').innerText = p.stock > 0 ? `Stok: ${p.stock}` : "Stok Habis";
            
            const btnWa = document.getElementById('btn-wa');
            if(p.stock <= 0) {
                btnWa.disabled = true;
                btnWa.classList.replace('bg-green-600', 'bg-slate-700');
                btnWa.innerText = "Stok Habis";
            } else {
                btnWa.disabled = false;
                btnWa.classList.replace('bg-slate-700', 'bg-green-600');
                btnWa.innerHTML = `<i class="fab fa-whatsapp text-xl"></i> Beli Sekarang`;
                btnWa.onclick = () => {
                createOrder(p);
                window.open(`https://wa.me/6288293064112?text=Halo Admin, saya mau order *${p.name}*`);
        };
            }

            document.getElementById('modal-detail').classList.remove('hidden');
        };

        // 3. ADMIN LOGIC
        window.checkAdminAccess = () => {
            const user = auth.currentUser;
            if(user.email === "xrezzkystore.id@gmail.com") {
                const pass = prompt("Masukkan Password Admin:");
                if(pass === "XREZZKY0930") {
                    showPage('page-admin');
                } else { alert("Password Salah!"); }
            } else {
                alert("Hanya Admin yang bisa mengakses fitur ini!");
            }
        };

        window.saveProduct = async () => {
            const name = document.getElementById('p-name').value;
            const price = document.getElementById('p-price').value;
            const img = document.getElementById('p-img').value;
            const desc = document.getElementById('p-desc').value;
            const stock = document.getElementById('p-stock').value;

            if(!name || !price || !img) return alert("Minimal nama, harga, dan foto diisi!");

            await push(ref(db, 'products'), {
            name,
            price,
            images: img.split(','), // pisahkan pakai koma
            description: desc,
            stock: parseInt(stock),
            createdAt: new Date().getTime()
                
    });

            alert("Produk Berhasil Ditambahkan!");
            // Reset Form
            document.querySelectorAll('#page-admin input, #page-admin textarea').forEach(i => i.value = "");
        };

        function listenStats() {
    onValue(ref(db, 'users'), (snap) => {
        const data = snap.val();
        document.getElementById('stat-users').innerText =
            data ? Object.keys(data).length : 0;
    });

    onValue(ref(db, 'products'), (snap) => {
        const data = snap.val();
        document.getElementById('stat-prods').innerText =
            data ? Object.keys(data).length : 0;
    });

    onValue(ref(db, 'users'), (snap) => {
        const list = document.getElementById('admin-user-list');
        list.innerHTML = "";

        snap.forEach(child => {
            const u = child.val();
            list.innerHTML += `
                <div class="flex justify-between items-center bg-slate-800 p-3 rounded-lg border border-slate-700">
                    <div>
                        <p class="font-bold text-xs">${u.username}</p>
                        <p class="text-[10px] text-gray-500">${u.email}</p>
                    </div>
                    <button onclick="deleteUser('${child.key}')" class="text-red-500 hover:text-red-400 text-xs">
                        <i class="fa fa-trash"></i>
                    </button>
                </div>
            `;
        });
    });
        }

        // 4. UTILS
        window.searchProduct = (query) => {
            const filtered = globalProducts.filter(p => p.name.toLowerCase().includes(query.toLowerCase()));
            const container = document.getElementById('product-list');
            // Re-render filtered list logic here...
        };

        window.showPage = (id) => {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        };

        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');

        window.resetPassword = () => {
            const email = prompt("Masukkan Email Akun:");
            if(email) {
                sendPasswordResetEmail(auth, email).then(() => alert("Link reset terkirim ke email!")).catch(e => alert(e.message));
            }
        };

        window.deleteUser = async (uid) => {
            if(confirm("Hapus akun ini dari database?")) {
                await remove(ref(db, 'users/' + uid));
                alert("User terhapus!");
            }
        }
        
        window.deleteProduct = async (id) => {
    if(confirm("Hapus produk ini?")) {

        // Hapus Produk
        await remove(ref(db, 'products/' + id));

        // Hapus Semua Rating Produk Itu
        await remove(ref(db, `ratings/${id}`));

        alert("Produk dan semua rating berhasil dihapus!");
    }
};

        window.toggleProfileMenu = () => {
    document.getElementById('profile-menu').classList.toggle('hidden');
};

window.logoutUser = async () => {
    await signOut(auth);
};

window.updateUsername = async () => {
    const newName = document.getElementById('new-username').value;
    const user = auth.currentUser;

    if(newName) {
        await update(ref(db, 'users/' + user.uid), {
            username: newName
        });
        alert("Username diperbarui!");
    }
};

window.changePassword = async () => {
    const user = auth.currentUser;
    const snap = await get(ref(db, 'users/' + user.uid));
    const data = snap.val();

    const now = Date.now();
    const last = data.lastPasswordChange || 0;

    if(now - last < 10800000) {
        alert("Password hanya bisa diganti 3 jam sekali!");
        return;
    }

    const newPass = prompt("Masukkan Password Baru:");
    if(newPass) {
        await user.updatePassword(newPass);
        await update(ref(db, 'users/' + user.uid), {
            lastPasswordChange: now
        });
        alert("Password berhasil diganti!");
    }
};

window.deleteAccount = async () => {
    const user = auth.currentUser;
    if(confirm("Yakin hapus akun permanen?")) {
        await remove(ref(db, 'users/' + user.uid));
        await user.delete();
        alert("Akun dihapus!");
    }
};
        
        
window.addToCart = async (productId, stock) => {
    const user = auth.currentUser;
    if (!user) return alert("Login dulu!");

    const cartRef = ref(db, `carts/${user.uid}/${productId}`);
    const snapshot = await get(cartRef);

    let qty = 1;
    if (snapshot.exists()) {
        qty = snapshot.val().quantity + 1;
        if (qty > stock) return alert("Stok tidak cukup!");
    }

    await set(cartRef, { quantity: qty });
    alert("Masuk keranjang!");
};
        
window.confirmOrder = async (userId, trxId) => {
    const trxRef = ref(db, `transactions/${userId}/${trxId}`);
    await update(trxRef, {
        status: "confirmed"
    });

    alert("Transaksi dikonfirmasi!");
};
        
window.loadCart = async () => {
    const user = auth.currentUser;
    const cartRef = ref(db, `carts/${user.uid}`);

    onValue(cartRef, async (snapshot) => {
        const container = document.getElementById("cartList");
        container.innerHTML = "";

        snapshot.forEach(async (child) => {
            const productId = child.key;
            const qty = child.val().quantity;

            const productSnap = await get(ref(db, `products/${productId}`));
            const product = productSnap.val();

            container.innerHTML += `
                <div>
                    ${product.name} 
                    <button onclick="changeQty('${productId}', -1, ${product.stock})">-</button>
                    ${qty}
                    <button onclick="changeQty('${productId}', 1, ${product.stock})">+</button>
                    <button onclick="removeCart('${productId}')">Hapus</button>
                </div>
            `;
        });
    });
};
        
window.changeQty = async (productId, change, stock) => {
    const user = auth.currentUser;
    const cartRef = ref(db, `carts/${user.uid}/${productId}`);
    const snapshot = await get(cartRef);

    let qty = snapshot.val().quantity + change;

    if (qty < 1) return alert("Minimal beli 1!");
    if (qty > stock) return alert("Melebihi stok!");

    await update(cartRef, { quantity: qty });
};

window.removeCart = async (productId) => {
    const user = auth.currentUser;
    await remove(ref(db, `carts/${user.uid}/${productId}`));
};
        
window.checkout = async () => {
    const user = auth.currentUser;
    const cartSnap = await get(ref(db, `carts/${user.uid}`));

    if (!cartSnap.exists()) return alert("Keranjang kosong!");

    const items = cartSnap.val();
    const total = 0;

    await push(ref(db, `transactions/${user.uid}`), {
        userId: user.uid,
        email: user.email,
        name: user.displayName || "User",
        items: items,
        createdAt: Date.now(),
        status: "Pending"
    });

    await remove(ref(db, `carts/${user.uid}`));
    alert("Pesanan dikirim!");
};
        window.loadRevenue = () => {
    const trxRef = ref(db, "transactions");
    let total = 0;

    onValue(trxRef, (snapshot) => {
        total = 0;

        if (!snapshot.exists()) return;

        snapshot.forEach(userSnap => {
            userSnap.forEach(trxSnap => {
                const t = trxSnap.val();

                if (t.status === "confirmed" && t.items) {
                    for (let key in t.items) {
                        total += t.items[key].price * t.items[key].quantity;
                    }
                }
            });
        });

        document.getElementById("totalRevenue").innerText =
            "Rp " + total.toLocaleString();
    });
};

        
function loadRevenue(){
    const trxRef = ref(db,"transactions");

    onValue(trxRef,(snapshot)=>{
        let total=0;
        let html="";

        snapshot.forEach(user=>{
            user.forEach(trx=>{
                const t=trx.val();

                if(t.status==="confirmed"){
                    total+=parseInt(t.price);
                }

                html+=`
                <div class="bg-slate-700 p-3 rounded mb-2">
                    <p><b>${t.name}</b> (${t.email})</p>
                    <p>Status: ${t.status}</p>
                    <button onclick="confirmTrx('${user.key}','${trx.key}')">‚úî</button>
                    <button onclick="rejectTrx('${user.key}','${trx.key}')">‚ùå</button>
                </div>`;
            });
        });

        document.getElementById("totalRevenue")
            .innerText="Rp "+total.toLocaleString();

        document.getElementById("adminTransactions")
            .innerHTML=html;
    });
}

window.confirmTrx=(uid,id)=>{
    update(ref(db,`transactions/${uid}/${id}`),
        {status:"confirmed"});
};

window.rejectTrx=(uid,id)=>{
    update(ref(db,`transactions/${uid}/${id}`),
        {status:"rejected"});
};
        
window.sendRating = async (productId, star, review) => {
    const user = auth.currentUser;
    const ratingRef = ref(db, `ratings/${productId}/${user.uid}`);

    const snap = await get(ratingRef);
    if (snap.exists()) return alert("Kamu sudah rating!");

    await set(ratingRef, {
        name: user.displayName || "User",
        email: user.email,
        star: star,
        review: review,
        createdAt: Date.now()
    });

    alert("Rating dikirim!");
};
        
window.loadRatings = (productId) => {
    const ratingRef = ref(db, `ratings/${productId}`);

    onValue(ratingRef, (snapshot) => {
        const container = document.getElementById("review-list");
        container.innerHTML = "";

        if (!snapshot.exists()) {
            container.innerHTML = `<p class="italic text-center text-gray-500">Belum ada ulasan untuk produk ini.</p>`;
            return;
        }

        snapshot.forEach(child => {
            const r = child.val();
            const date = new Date(r.createdAt).toLocaleString();

            container.innerHTML += `
                <div class="bg-slate-800 p-3 rounded-lg border border-slate-700">
                    <p class="text-yellow-400 font-bold">‚≠ê ${r.star}/5</p>
                    <p class="text-xs">${r.name} (${r.email})</p>
                    <p class="text-xs text-gray-400 mt-1">${r.review}</p>
                    <p class="text-[10px] text-gray-500 mt-2">${date}</p>
                </div>
            `;
        });
    });
};
        
window.loadHistory = () => {
    const user = auth.currentUser;
    const trxRef = ref(db, `transactions/${user.uid}`);

    onValue(trxRef, (snapshot) => {
        const container = document.getElementById("historyList");
        container.innerHTML = "";

        if (!snapshot.exists()) {
            container.innerHTML = "Belum ada transaksi";
            return;
        }

        snapshot.forEach(child => {
            const trx = child.val();
            const date = new Date(trx.createdAt).toLocaleString();

            container.innerHTML += `
                <div class="bg-slate-700 p-3 rounded mb-2">
                    <p>Status: ${trx.status}</p>
                    <p>Tanggal: ${date}</p>
                </div>
            `;
        });
    });
};
        
    </script>
</body>
    </html>
