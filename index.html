<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XREZZKY STORE | Premium Marketplace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: white; overflow-x: hidden; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .hidden { display: none; }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 10px; }
    </style>
</head>
<body>

    <div id="profile-menu" class="hidden fixed top-16 left-4 glass p-4 rounded-xl w-64 z-50">
    <p id="profile-join" class="text-xs text-gray-400 mb-3"></p>

    <input type="text" id="new-username"
    placeholder="Ubah Username"
    class="w-full p-2 mb-2 rounded bg-slate-800 border border-slate-700 text-xs">

    <button onclick="updateUsername()"
    class="w-full bg-blue-600 py-2 rounded text-xs mb-2">
    Update Username</button>

    <button onclick="changePassword()"
    class="w-full bg-yellow-600 py-2 rounded text-xs mb-2">
    Ubah Password</button>

    <button onclick="logoutUser()"
    class="w-full bg-gray-600 py-2 rounded text-xs mb-2">
    Logout</button>

    <button onclick="deleteAccount()"
    class="w-full bg-red-600 py-2 rounded text-xs">
    Hapus Akun</button>
    </div>
    
    <div id="loader" class="fixed inset-0 flex items-center justify-center bg-slate-900 z-[999]">
        <div class="text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-blue-500 border-opacity-50 mb-4"></div>
            <p class="text-blue-400 font-bold tracking-widest">XREZZKY STORE</p>
        </div>
    </div>

    <section id="page-auth" class="hidden min-h-screen flex items-center justify-center p-6">
        <div class="glass p-8 rounded-2xl w-full max-w-md shadow-2xl">
            <h2 id="auth-title" class="text-3xl font-bold mb-2 text-center text-blue-500">Welcome</h2>
            <p id="auth-subtitle" class="text-gray-400 text-center mb-8 text-sm">Silahkan login untuk belanja</p>
            
            <div class="space-y-4">
                <div id="reg-fields" class="hidden space-y-4">
                    <input type="text" id="auth-user" placeholder="Username" class="w-full p-4 rounded-xl bg-slate-800 border border-slate-700 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <input type="email" id="auth-email" placeholder="Email Address" class="w-full p-4 rounded-xl bg-slate-800 border border-slate-700 focus:ring-2 focus:ring-blue-500 outline-none">
                <input type="password" id="auth-pass" placeholder="Password" class="w-full p-4 rounded-xl bg-slate-800 border border-slate-700 focus:ring-2 focus:ring-blue-500 outline-none">
                
                <button onclick="handleAuth()" id="btn-auth" class="w-full bg-blue-600 hover:bg-blue-700 py-4 rounded-xl font-bold transition-all transform active:scale-95 shadow-lg shadow-blue-900/20">Login</button>
                
                <div class="flex flex-col gap-3 text-center text-sm mt-6">
                    <span onclick="toggleAuthMode()" id="auth-toggle-text" class="text-blue-400 cursor-pointer hover:underline">Belum punya akun? Daftar sekarang</span>
                    <span onclick="resetPassword()" class="text-gray-500 cursor-pointer hover:text-white">Lupa kata sandi?</span>
                </div>
            </div>
        </div>
    </section>

    <section id="page-marketplace" class="hidden min-h-screen">
        <header class="p-5 glass sticky top-0 z-40 flex justify-between items-center">
            <div class="flex items-center gap-3" onclick="toggleProfileMenu()">
                <img id="user-avatar" src="https://ui-avatars.com/api/?name=User&background=3b82f6&color=fff" class="w-10 h-10 rounded-full border-2 border-blue-500">
                <div>
                    <p class="text-[10px] text-gray-400 uppercase tracking-tighter">Halo, Akun Saya</p>
                    <p id="user-name-display" class="font-bold text-sm truncate w-24">Guest</p>
                </div>
            </div>
            <div class="flex-1 px-4">
                <input type="text" onkeyup="searchProduct(this.value)" placeholder="Cari produk..." class="w-full bg-slate-800 py-2 px-4 rounded-full text-xs border border-slate-700 focus:ring-1 focus:ring-blue-500 outline-none">
            </div>
        </header>

        <main class="p-4 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4" id="product-list">
            </main>

        <div class="fixed bottom-6 left-1/2 -translate-x-1/2 flex items-center gap-8 px-8 py-4 glass rounded-full z-50 shadow-2xl">
            <button onclick="showPage('page-marketplace')" class="text-blue-500"><i class="fa fa-home text-xl"></i></button>
            <a href="https://xrezzky-web.github.io/xrezzkystore/" class="bg-blue-600 p-4 rounded-full -mt-12 border-8 border-slate-900 shadow-xl"><i class="fa fa-shop text-white"></i></a>
            <button onclick="checkAdminAccess()" class="text-gray-400"><i class="fa fa-grid-2 text-xl"></i><i class="fa fa-user-shield text-xl"></i></button>
        </div>
    </section>

    <section id="page-admin" class="hidden min-h-screen p-6 pb-24">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-2xl font-bold text-blue-500">Admin Panel</h1>
            <button onclick="showPage('page-marketplace')" class="bg-slate-700 px-4 py-2 rounded-lg text-xs">Keluar Admin</button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="glass p-6 rounded-2xl">
                <h3 class="font-bold mb-4 border-b border-slate-700 pb-2">Upload Produk Baru</h3>
                <div class="space-y-3">
                    <input type="text" id="p-name" placeholder="Nama Produk" class="w-full p-3 rounded bg-slate-800 border border-slate-700">
                    <input type="number" id="p-price" placeholder="Harga (Angka)" class="w-full p-3 rounded bg-slate-800 border border-slate-700">
                    <input type="text" id="p-img" placeholder="URL Foto Produk" class="w-full p-3 rounded bg-slate-800 border border-slate-700">
                    <textarea id="p-desc" placeholder="Detail Produk" class="w-full p-3 rounded bg-slate-800 border border-slate-700 h-24"></textarea>
                    <input type="number" id="p-stock" placeholder="Jumlah Stok" class="w-full p-3 rounded bg-slate-800 border border-slate-700">
                    <button onclick="saveProduct()" class="w-full bg-green-600 py-3 rounded-xl font-bold mt-2">Posting Produk</button>
                </div>
            </div>

            <div class="glass p-6 rounded-2xl">
                <h3 class="font-bold mb-4 border-b border-slate-700 pb-2">Laporan Penjualan</h3>
                <div id="admin-stats" class="grid grid-cols-2 gap-4">
                    <div class="bg-blue-900/30 p-4 rounded-xl text-center">
                        <p class="text-xs text-blue-300">Total User</p>
                        <p id="stat-users" class="text-2xl font-bold">0</p>
                    </div>
                    <div class="bg-green-900/30 p-4 rounded-xl text-center">
                        <p class="text-xs text-green-300">Total Produk</p>
                        <p id="stat-prods" class="text-2xl font-bold">0</p>
                    </div>
                </div>
                <div class="mt-6">
                    <h4 class="text-sm font-bold mb-2">Daftar Pengguna</h4>
                    <div id="admin-user-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
                    <h4 class="text-sm font-bold mb-2 mt-4">Pesanan Masuk</h4>
                    <div id="admin-order-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
                </div>
            </div>
        </div>
    </section>

    <div id="modal-detail" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/90">
        <div class="bg-slate-900 w-full max-w-xl rounded-3xl overflow-hidden relative border border-slate-700">
            <button onclick="closeModal('modal-detail')" class="absolute top-4 right-4 bg-white/10 p-2 rounded-full hover:bg-red-500 transition"><i class="fa fa-times w-5 h-5 flex items-center justify-center"></i></button>
            <img id="m-img" src="" class="w-full h-72 object-cover" onclick="viewImageFull(this.src)">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <h2 id="m-title" class="text-2xl font-bold"></h2>
                    <span id="m-stock" class="bg-blue-600/20 text-blue-400 text-[10px] px-3 py-1 rounded-full border border-blue-500/30"></span>
                </div>
                <p id="m-price" class="text-xl font-bold text-blue-500 mb-4"></p>
                <p id="m-desc" class="text-gray-400 text-sm mb-6 leading-relaxed"></p>
                
                <div class="grid grid-cols-2 gap-3">
                    <button id="btn-wa" class="bg-green-600 py-4 rounded-2xl font-bold flex items-center justify-center gap-2 transition hover:bg-green-700"><i class="fab fa-whatsapp text-xl"></i> Beli Sekarang</button>
                    <button onclick="alert('Masuk ke Keranjang!')" class="bg-slate-800 py-4 rounded-2xl font-bold border border-slate-700">Keranjang</button>
                </div>

                <div class="mt-8 pt-6 border-t border-slate-800">
                    <h4 class="font-bold mb-4 flex items-center gap-2"><i class="fa fa-star text-yellow-500"></i> Ulasan Pembeli</h4>
                    <div id="review-list" class="space-y-4 max-h-40 overflow-y-auto text-xs text-gray-500">
                        <p class="italic text-center">Belum ada ulasan untuk produk ini.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getAuth,
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  onAuthStateChanged,
  signOut,
  sendPasswordResetEmail,
  updatePassword,
  deleteUser
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

import {
  getDatabase,
  ref,
  set,
  get,
  onValue,
  push,
  remove,
  update
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* ================= FIREBASE ================= */

const firebaseConfig = {
  apiKey: "AIzaSyA75bdcfawOi957by8y_4-l4sJCCo6pF88",
  authDomain: "xrezzkystore-marketplace-83bc0.firebaseapp.com",
  databaseURL: "https://xrezzkystore-marketplace-83bc0-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "xrezzkystore-marketplace-83bc0",
  storageBucket: "xrezzkystore-marketplace-83bc0.appspot.com",
  messagingSenderId: "604900856944",
  appId: "1:604900856944:web:c48c973da45214c68a10b5"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

/* ================= ELEMENT SELECT ================= */

const authEmail = document.getElementById("auth-email");
const authPass = document.getElementById("auth-pass");
const authUser = document.getElementById("auth-user");
const btnAuth = document.getElementById("btn-auth");
const loader = document.getElementById("loader");
const productList = document.getElementById("product-list");
const adminOrderList = document.getElementById("admin-order-list");
const userNameDisplay = document.getElementById("user-name-display");
const userAvatar = document.getElementById("user-avatar");
const regFields = document.getElementById("reg-fields");

let currentUserData = null;
let globalProducts = [];
let isLogin = true;

/* ================= AUTH ================= */

window.toggleAuthMode = () => {
  isLogin = !isLogin;

  btnAuth.innerText = isLogin ? "Login" : "Daftar";
  regFields.classList.toggle("hidden");
};

window.handleAuth = async () => {
  if (!authEmail.value || !authPass.value) return alert("Isi data!");

  try {
    if (isLogin) {
      await signInWithEmailAndPassword(auth, authEmail.value, authPass.value);
    } else {
      const res = await createUserWithEmailAndPassword(auth, authEmail.value, authPass.value);
      await set(ref(db, "users/" + res.user.uid), {
        username: authUser.value || authEmail.value.split("@")[0],
        email: authEmail.value,
        role: authEmail.value === "xrezzkystore.id@gmail.com" ? "admin" : "user",
        join: Date.now()
      });
    }
  } catch (e) {
    alert(e.message);
  }
};

window.resetPassword = async () => {
  if (!authEmail.value) return alert("Masukkan email dulu!");
  await sendPasswordResetEmail(auth, authEmail.value);
  alert("Email reset terkirim!");
};

onAuthStateChanged(auth, async (user) => {
  loader.classList.add("hidden");

  if (user) {
    const snap = await get(ref(db, "users/" + user.uid));
    currentUserData = snap.val();

    userNameDisplay.innerText = currentUserData.username;
    userAvatar.src =
      `https://ui-avatars.com/api/?name=${currentUserData.username}&background=3b82f6&color=fff`;

    showPage("page-marketplace");
    listenProducts();
    listenOrders();
  } else {
    showPage("page-auth");
  }
});

/* ================= PROFILE ================= */

window.toggleProfileMenu = () => {
  document.getElementById("profile-menu").classList.toggle("hidden");
};

window.logoutUser = async () => {
  await signOut(auth);
};

window.updateUsername = async () => {
  const newName = document.getElementById("new-username").value;
  if (!newName) return alert("Isi username baru!");

  await update(ref(db, "users/" + auth.currentUser.uid), {
    username: newName
  });

  alert("Username diperbarui!");
  location.reload();
};

window.changePassword = async () => {
  const newPass = prompt("Masukkan password baru:");
  if (!newPass) return;
  await updatePassword(auth.currentUser, newPass);
  alert("Password diubah!");
};

window.deleteAccount = async () => {
  if (!confirm("Yakin hapus akun?")) return;

  await remove(ref(db, "users/" + auth.currentUser.uid));
  await deleteUser(auth.currentUser);
  alert("Akun dihapus!");
};

/* ================= PRODUCTS ================= */

function listenProducts() {
  onValue(ref(db, "products"), (snap) => {
    productList.innerHTML = "";
    globalProducts = [];

    if (!snap.exists()) {
      productList.innerHTML = "<p>Belum ada produk</p>";
      return;
    }

    snap.forEach((child) => {
      const p = child.val();
      const id = child.key;
      globalProducts.push({ ...p, id });

      productList.innerHTML += `
      <div class="glass p-3 rounded-xl">
        <img src="${p.image}" class="h-40 w-full object-cover rounded">
        <h3 class="font-bold mt-2 text-sm">${p.name}</h3>
        <p class="text-blue-500 text-sm">Rp ${Number(p.price).toLocaleString()}</p>
        <p class="text-xs">Stok: ${p.stock}</p>
      </div>`;
    });
  });
}

/* ================= ADMIN ================= */

window.checkAdminAccess = () => {
  if (currentUserData?.role === "admin") {
    showPage("page-admin");
    loadAdminStats();
  } else {
    alert("Bukan admin!");
  }
};

window.saveProduct = async () => {
  const name = document.getElementById("p-name").value;
  const price = document.getElementById("p-price").value;
  const img = document.getElementById("p-img").value;
  const desc = document.getElementById("p-desc").value;
  const stock = document.getElementById("p-stock").value;

  if (!name || !price || !img) return alert("Lengkapi data!");

  await push(ref(db, "products"), {
    name,
    price,
    image: img,
    desc,
    stock: Number(stock),
    createdAt: Date.now()
  });

  alert("Produk ditambahkan!");
};

function loadAdminStats() {
  onValue(ref(db, "users"), (snap) => {
    document.getElementById("stat-users").innerText = snap.size || 0;
  });

  onValue(ref(db, "products"), (snap) => {
    document.getElementById("stat-prods").innerText = snap.size || 0;
  });
}

function listenOrders() {
  if (currentUserData?.role !== "admin") return;

  onValue(ref(db, "orders"), (snap) => {
    adminOrderList.innerHTML = "";
    snap.forEach((child) => {
      const o = child.val();
      adminOrderList.innerHTML += `
      <div class="bg-slate-800 p-3 rounded text-xs">
        <p>${o.username}</p>
        <p>${o.email}</p>
        <p>${o.status}</p>
      </div>`;
    });
  });
}

/* ================= SEARCH ================= */

window.searchProduct = (q) => {
  productList.innerHTML = "";

  globalProducts
    .filter(p => p.name.toLowerCase().includes(q.toLowerCase()))
    .forEach(p => {
      productList.innerHTML += `
      <div class="glass p-3 rounded-xl">
        <img src="${p.image}" class="h-40 w-full object-cover rounded">
        <h3 class="font-bold mt-2 text-sm">${p.name}</h3>
        <p class="text-blue-500 text-sm">Rp ${Number(p.price).toLocaleString()}</p>
      </div>`;
    });
};

/* ================= UTILS ================= */

window.showPage = (id) => {
  document.querySelectorAll("section").forEach(s => s.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
};
</script>
</body>
</html>
