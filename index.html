<!DOCTYPE html><html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>XREZZKY STORE Marketplace</title><!-- Firebase --><script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged, updateProfile, signOut, deleteUser } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getDatabase, ref, set, push, onValue, remove, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyA75bdcfawOi957by8y_4-l4sJCCo6pF88",
  authDomain: "xrezzkystore-marketplace-83bc0.firebaseapp.com",
  databaseURL: "https://xrezzkystore-marketplace-83bc0-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "xrezzkystore-marketplace-83bc0",
  storageBucket: "xrezzkystore-marketplace-83bc0.firebasestorage.app",
  messagingSenderId: "604900856944",
  appId: "1:604900856944:web:c48c973da45214c68a10b5"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const ADMIN_EMAIL = "xrezzkystore.id@gmail.com";

window.register = async()=>{
  const u = reg_username.value;
  const e = reg_email.value;
  const p = reg_password.value;
  const cred = await createUserWithEmailAndPassword(auth,e,p);
  await updateProfile(cred.user,{displayName:u});
  await set(ref(db,'users/'+cred.user.uid),{
    username:u,
    email:e,
    role:'user',
    created:Date.now()
  });
  alert('Daftar berhasil');
};

window.login = async()=>{
  await signInWithEmailAndPassword(auth,login_email.value,login_password.value);
};

window.resetPassword = async()=>{
  await sendPasswordResetEmail(auth,reset_email.value);
  alert('Email reset terkirim');
};

window.logout = async()=>{ await signOut(auth); };

onAuthStateChanged(auth, async(user)=>{
  if(!user){ show('login'); return; }
  const snap = await get(ref(db,'users/'+user.uid));
  const data = snap.val();
  user_email.innerText = user.email;
  user_name.innerText = data.username;
  if(user.email===ADMIN_EMAIL){ show('admin'); loadAdmin(); }
  else{ show('market'); loadProducts(); loadHistory(user.uid); }
});

function show(p){
  login_page.style.display='none';
  market_page.style.display='none';
  admin_page.style.display='none';
  if(p==='login')login_page.style.display='block';
  if(p==='market')market_page.style.display='block';
  if(p==='admin')admin_page.style.display='block';
}

/* PRODUCTS */
function loadProducts(){
  onValue(ref(db,'products'),snap=>{
    product_list.innerHTML='';
    snap.forEach(d=>{
      const p=d.val();
      product_list.innerHTML+=`
      <div class="product">
        <div class="img" onclick="viewImg()">FOTO</div>
        <b>${p.name}</b>
        <div>Stok: ${p.stock}</div>
        <div>${p.detail}</div>
        <button onclick="buy()">BELI</button>
        <button onclick="addCart('${d.key}')">KERANJANG</button>
        <button onclick="ask()">TANYA</button>
        <button onclick="testi('${d.key}')">TESTI PEMBELI</button>
      </div>`;
    });
  });
}

window.buy=()=>location.href='https://wa.me/6288293064112';
window.ask=()=>alert('Hubungi admin');

window.addCart=(id)=>{
  push(ref(db,'cart/'+auth.currentUser.uid),{product:id,time:Date.now()});
  alert('Masuk keranjang');
};

function loadHistory(uid){
  onValue(ref(db,'transactions/'+uid),s=>{
    history.innerHTML='';
    s.forEach(d=>{
      history.innerHTML+=`<div>${new Date(d.val().time).toLocaleString()}</div>`;
    });
  });
}

/* ADMIN */
function loadAdmin(){
  onValue(ref(db,'products'),s=>{
    admin_products.innerHTML='';
    s.forEach(d=>{
      const p=d.val();
      admin_products.innerHTML+=`<div>${p.name} <button onclick="delProduct('${d.key}')">Hapus</button></div>`;
    });
  });
}

window.addProduct=()=>{
  push(ref(db,'products'),{
    name:prod_name.value,
    detail:prod_detail.value,
    stock:prod_stock.value
  });
};

window.delProduct=(id)=>{ remove(ref(db,'products/'+id)); };
</script><style>
body{margin:0;font-family:Arial;background:#999}
.page{display:none}
.card{background:#fff;width:90%;max-width:420px;margin:60px auto;padding:24px;border-radius:20px}
input,button{width:100%;padding:12px;margin:6px 0;border-radius:12px;border:1px solid #ccc}
button{background:#22e0e0;border:none;font-weight:bold}
header{background:#5bc0eb;padding:10px;display:flex;justify-content:space-between}
.product{background:#eee;margin:12px;padding:12px;border-radius:16px}
.img{background:#00ff00;height:180px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:bold}
</style></head>
<body><!-- LOGIN --><div id="login_page" class="page">
  <div class="card">
    <h2 align="center">MARKETPLACE<br>XREZZKY STORE</h2>
    <input id="login_email" placeholder="Gmail">
    <input id="login_password" type="password" placeholder="Password">
    <button onclick="login()">LOGIN</button>
    <div onclick="reg.style.display='block'">Daftar</div>
    <div onclick="reset.style.display='block'">Lupa Password</div><div id="reg" style="display:none">
  <input id="reg_username" placeholder="Username">
  <input id="reg_email" placeholder="Gmail">
  <input id="reg_password" type="password" placeholder="Password">
  <button onclick="register()">DAFTAR</button>
</div>

<div id="reset" style="display:none">
  <input id="reset_email" placeholder="Gmail">
  <button onclick="resetPassword()">RESET</button>
</div>

  </div>
</div><!-- MARKETPLACE --><div id="market_page" class="page">
<header>
  <div>ðŸ‘¤ <span id="user_name"></span></div>
  <button onclick="logout()">Logout</button>
</header>
<div id="product_list"></div>
<h3>Riwayat Transaksi</h3>
<div id="history"></div>
<div style="text-align:center">
  <button onclick="location.href='https://xrezzky-web.github.io/xrezzkystore/'">HOME</button>
</div>
</div><!-- ADMIN --><div id="admin_page" class="page">
<header>ADMIN PANEL</header>
<input id="prod_name" placeholder="Nama Produk">
<input id="prod_stock" placeholder="Stok">
<input id="prod_detail" placeholder="Detail">
<button onclick="addProduct()">Tambah Produk</button>
<h3>Produk</h3>
<div id="admin_products"></div>
<button onclick="logout()">Logout</button>
</div></body>
</html>
